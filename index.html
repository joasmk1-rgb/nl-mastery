<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>NL Mastery - Ultimate Pro</title>
    <style>
        :root { --duo-green: #58cc02; --duo-red: #ff4b4b; --duo-blue: #1cb0f6; --duo-gray: #e5e5e5; --duo-purple: #ce82ff; --duo-gold: #ffc800; }
        body { font-family: 'Segoe UI', sans-serif; background: #f7f7f7; margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        
        /* Menu */
        .menu { display: flex; gap: 5px; padding: 10px; width: 100%; overflow-x: auto; background: white; border-bottom: 2px solid var(--duo-gray); box-sizing: border-box; }
        .menu button { padding: 10px 15px; border-radius: 12px; border: 2px solid var(--duo-gray); background: white; font-weight: bold; cursor: pointer; white-space: nowrap; font-size: 0.8rem; flex-shrink: 0; }
        .menu button.active { background: var(--duo-blue); color: white; border-color: #1a9bd9; }

        /* Vues */
        .view { display: none; width: 100%; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; flex-grow: 1; }
        .view.active { display: flex; }

        /* √âcriture */
        .write-box { width: 95%; max-width: 450px; background: white; padding: 30px; border-radius: 20px; border: 2px solid var(--duo-gray); text-align: center; box-shadow: 0 4px 0 var(--duo-gray); }
        input { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid var(--duo-gray); font-size: 1.1rem; text-align: center; margin-top: 20px; outline: none; box-sizing: border-box; }
        input:focus { border-color: var(--duo-blue); border-width: 3px; }
        #write-feedback { margin-top: 15px; font-weight: bold; min-height: 1.2em; }

        /* Duel Local */
        #duel-view { padding: 0; height: 100%; justify-content: space-between; }
        .player-zone { width: 100%; height: 49%; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; padding: 20px; box-sizing: border-box; }
        #p1 { transform: rotate(180deg); background: #fff5f5; }
        #p2 { background: #f5faff; }
        .duel-word { font-size: 1.4rem; font-weight: bold; margin-bottom: 20px; text-align: center; }
        .duel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 300px; }
        .duel-btn { padding: 15px; border-radius: 12px; border: none; background: white; border: 2px solid var(--duo-gray); font-weight: bold; cursor: pointer; font-size: 0.9rem; }

        /* Duel Asynchrone (Share) */
        .share-box { background: #fff; padding: 20px; border-radius: 15px; border: 2px dashed var(--duo-gold); text-align: center; margin-top: 20px; width: 90%; }
        .code-display { font-family: monospace; background: #eee; padding: 10px; border-radius: 5px; display: block; margin: 10px 0; word-break: break-all; }

        /* Stats bar */
        .stats-header { font-size: 0.75rem; font-weight: bold; color: #777; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="menu">
        <button id="btn-write" class="active" onclick="switchView('write')">‚úçÔ∏è √âcriture</button>
        <button id="btn-duel" onclick="switchView('duel')">‚öîÔ∏è Duel Local</button>
        <button id="btn-share" onclick="switchView('share')">üèÜ D√©fis</button>
    </div>

    <div id="write-view" class="view active">
        <div class="stats-header">Mots ma√Ætris√©s: <span id="mast-count">0</span> / 2000</div>
        <div class="write-box">
            <small id="type-label" style="color:var(--duo-purple); font-weight:bold;"></small>
            <p id="write-q" style="font-size: 1.3rem; font-weight: bold; margin: 15px 0;">Chargement...</p>
            <input type="text" id="write-input" placeholder="Tapez en n√©erlandais..." autocomplete="off">
            <p id="write-feedback"></p>
        </div>
    </div>

    <div id="duel-view" class="view">
        <div class="player-zone" id="p1">
            <div id="d-q1" class="duel-word">...</div>
            <div id="d-opts1" class="duel-grid"></div>
        </div>
        <div class="player-zone" id="p2">
            <div id="d-q2" class="duel-word">...</div>
            <div id="d-opts2" class="duel-grid"></div>
        </div>
    </div>

    <div id="share-view" class="view">
        <div class="share-box">
            <h3>D√©fier un ami</h3>
            <p>Ton score actuel est bas√© sur tes mots ma√Ætris√©s.</p>
            <button onclick="generateShareCode()" style="padding:10px; background:var(--duo-gold); border:none; border-radius:8px; font-weight:bold; cursor:pointer;">G√©n√©rer mon Code D√©fi</button>
            <span id="share-code-out" class="code-display">Code s'affichera ici...</span>
        </div>

        <div class="share-box" style="border-color: var(--duo-blue);">
            <h3>Relever un d√©fi</h3>
            <input type="text" id="input-challenge" placeholder="Coller le code ici..." style="margin-top:0;">
            <button onclick="loadChallenge()" style="padding:10px; background:var(--duo-blue); border:none; border-radius:8px; font-weight:bold; color:white; margin-top:10px; cursor:pointer;">Lancer le D√©fi</button>
        </div>
    </div>

    <script>
        let fullDb = [];
        let userData = JSON.parse(localStorage.getItem('nl_mastery_final')) || { mastered: [], score: 0 };
        let currentItem = null;

        // --- CHARGEMENT DES DONN√âES ---
        async function loadData() {
            const files = ['PHRASES_LABO.csv', 'MOTS_LABO.csv'];
            for (let f of files) {
                try {
                    const r = await fetch(f);
                    const t = await r.text();
                    const lines = t.split(/\r?\n/).slice(1);
                    lines.forEach(line => {
                        const cols = line.split(';');
                        if(cols.length >= 3) {
                            fullDb.push({ id: cols[0], fr: cols[1], nl: cols[2].trim(), type: f.includes('MOTS') ? 'MOT' : 'PHRASE' });
                        }
                    });
                } catch(e) { console.error("Erreur chargement:", f); }
            }
            updateStats();
            nextWrite();
        }

        // --- NAVIGATION ---
        function switchView(v) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.menu button').forEach(el => el.classList.remove('active'));
            document.getElementById(v + '-view').classList.add('active');
            document.getElementById('btn-' + v).classList.add('active');
            if(v === 'duel') startDuel();
        }

        // --- LOGIQUE √âCRITURE ---
        function nextWrite() {
            // On pioche un mot pas encore ma√Ætris√© si possible
            let pool = fullDb.filter(i => !userData.mastered.includes(i.id));
            if(pool.length === 0) pool = fullDb;
            
            currentItem = pool[Math.floor(Math.random()*pool.length)];
            document.getElementById('type-label').innerText = currentItem.type;
            document.getElementById('write-q').innerText = currentItem.fr;
            document.getElementById('write-input').value = "";
            document.getElementById('write-feedback').innerText = "";
            document.getElementById('write-input').focus();
        }

        document.getElementById('write-input').addEventListener('keypress', function(e) {
            if(e.key === 'Enter') {
                let userVal = this.value.toLowerCase().trim();
                let correctVal = currentItem.nl.toLowerCase().trim();
                
                if(userVal === correctVal) {
                    showFeedback("‚úÖ Correct !", "var(--duo-green)");
                    if(!userData.mastered.includes(currentItem.id)) {
                        userData.mastered.push(currentItem.id);
                        userData.score += 10;
                    }
                    save();
                    setTimeout(nextWrite, 1200);
                } else {
                    showFeedback("‚ùå " + currentItem.nl, "var(--duo-red)");
                }
            }
        });

        function showFeedback(txt, color) {
            const f = document.getElementById('write-feedback');
            f.innerText = txt;
            f.style.color = color;
        }

        // --- LOGIQUE DUEL LOCAL ---
        function startDuel() {
            if(fullDb.length < 2) return;
            let item = fullDb[Math.floor(Math.random()*fullDb.length)];
            let others = fullDb.filter(i => i.id !== item.id).sort(() => 0.5 - Math.random()).slice(0, 3);
            let choices = [item, ...others].sort(() => 0.5 - Math.random());

            [1, 2].forEach(p => {
                document.getElementById('d-q' + p).innerText = item.fr;
                const grid = document.getElementById('d-opts' + p);
                grid.innerHTML = "";
                choices.forEach(c => {
                    let b = document.createElement('button');
                    b.className = "duel-btn";
                    b.innerText = c.nl;
                    b.onclick = () => {
                        if(c.id === item.id) {
                            alert("Point pour Joueur " + p + " !");
                            startDuel();
                        } else {
                            b.style.background = "var(--duo-red)";
                            b.style.color = "white";
                        }
                    };
                    grid.appendChild(b);
                });
            });
        }

        // --- ASYNCHRONE / D√âFIS ---
        function generateShareCode() {
            // Un code simple : "NL-Score-NombreDeMots"
            const code = `NL-${userData.score}-${userData.mastered.length}-${Date.now().toString().slice(-4)}`;
            document.getElementById('share-code-out').innerText = code;
        }

        function loadChallenge() {
            const val = document.getElementById('input-challenge').value;
            if(val.startsWith("NL-")) {
                const parts = val.split('-');
                alert(`D√©fi accept√© ! Score √† battre : ${parts[1]} points (${parts[2]} mots). Bonne chance !`);
                switchView('write');
            } else {
                alert("Code invalide");
            }
        }

        // --- SYSTEME ---
        function save() {
            localStorage.setItem('nl_mastery_final', JSON.stringify(userData));
            updateStats();
        }

        function updateStats() {
            document.getElementById('mast-count').innerText = userData.mastered.length;
        }

        window.onload = loadData;
    </script>
</body>
</html>
