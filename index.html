<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>NL Mastery - La Totale</title>
    <style>
        :root { --duo-green: #58cc02; --duo-red: #ff4b4b; --duo-blue: #1cb0f6; --duo-gray: #e5e5e5; --duo-purple: #ce82ff; --duo-orange: #ff9600; }
        body { font-family: 'Segoe UI', sans-serif; background: #f7f7f7; margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        
        /* Barre de Progression Royale */
        .top-bar { width: 100%; background: white; border-bottom: 2px solid var(--duo-gray); padding: 10px 0; display: flex; flex-direction: column; align-items: center; }
        .stats-row { display: flex; justify-content: space-between; width: 90%; max-width: 500px; font-weight: bold; color: #4b4b4b; font-size: 0.8rem; }
        .p-container { width: 90%; max-width: 500px; background: var(--duo-gray); height: 12px; border-radius: 6px; overflow: hidden; margin-top: 5px; }
        .p-bar { width: 0%; height: 100%; background: var(--duo-green); transition: width 0.5s; }

        .menu { display: flex; gap: 5px; padding: 10px; width: 100%; overflow-x: auto; background: white; border-bottom: 1px solid #ddd; }
        .menu button { padding: 8px 15px; border-radius: 12px; border: 2px solid var(--duo-gray); background: white; font-weight: bold; cursor: pointer; white-space: nowrap; font-size: 0.8rem; }
        .menu button.active { background: var(--duo-blue); color: white; }

        .view { display: none; width: 100%; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; overflow-y: auto; flex-grow: 1; }
        .view.active { display: flex; }

        /* Styles √âcriture & Cartes */
        .card { width: 90%; max-width: 400px; background: white; padding: 30px; border-radius: 20px; border: 2px solid var(--duo-gray); text-align: center; box-shadow: 0 5px 0 var(--duo-gray); margin-bottom: 20px; }
        input { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid var(--duo-gray); font-size: 1.1rem; text-align: center; outline: none; margin-top: 15px; }
        
        .btn-action { width: 90%; max-width: 400px; padding: 15px; border-radius: 15px; border: none; color: white; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 10px; }
        .btn-check { background: var(--duo-green); box-shadow: 0 4px 0 #45a302; }
        .btn-skip { background: #ccc; color: #666; font-size: 0.8rem; }

        /* Duel Local */
        #duel-view { padding: 0; justify-content: space-between; }
        .player-zone { width: 100%; height: 49%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        #p1 { transform: rotate(180deg); background: #fff5f5; }
        #p2 { background: #f5faff; }
        .duel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="stats-row">
            <span>LVL <span id="lvl">1</span></span>
            <span>MA√éTRISE: <span id="mastered-count">0</span></span>
            <span>XP: <span id="xp">0</span></span>
        </div>
        <div class="p-container"><div class="p-bar" id="p-bar"></div></div>
    </div>

    <div class="menu">
        <button class="active" onclick="switchView('learn', this)">‚úçÔ∏è Apprendre</button>
        <button onclick="switchView('duel', this)">‚öîÔ∏è Duel</button>
        <button onclick="switchView('review', this)">üî• Focus (√Ä revoir)</button>
    </div>

    <div id="learn-view" class="view active">
        <div class="card">
            <small id="tag" style="color:var(--duo-purple); font-weight:bold; text-transform:uppercase;"></small>
            <p id="q-text" style="font-size: 1.4rem; font-weight: bold; margin: 15px 0;">Chargement...</p>
            <input type="text" id="ans-input" placeholder="R√©ponse en NL..." autocomplete="off">
            <p id="feedback" style="font-weight:bold; margin-top:10px;"></p>
        </div>
        <button class="btn-action btn-check" onclick="checkAnswer()">V√âRIFIER</button>
        <button class="btn-action btn-skip" onclick="nextQuestion()">PASSER / JE NE SAIS PAS</button>
    </div>

    <div id="duel-view" class="view">
        <div class="player-zone" id="p1"><div id="dq1" style="font-weight:bold;margin-bottom:10px"></div><div id="do1" class="duel-grid"></div></div>
        <div class="player-zone" id="p2"><div id="dq2" style="font-weight:bold;margin-bottom:10px"></div><div id="do2" class="duel-grid"></div></div>
    </div>

    <div id="review-view" class="view">
        <h3>Mots √† travailler ‚ö†Ô∏è</h3>
        <div id="review-list" style="width:100%"></div>
    </div>

    <script>
        let db = [];
        let state = JSON.parse(localStorage.getItem('nl_master_global')) || { mastered: [], toReview: [], xp: 0 };
        let current = null;

        async function init() {
            // FUSION DE TOUS LES FICHIERS
            const files = ['THEME_BASE.csv', 'VERBENL.csv', 'NOMNL.csv', 'ADJNL.csv', 'PHRASES_LABO.csv', 'MOTS_LABO.csv'];
            for (let f of files) {
                try {
                    const r = await fetch(f); if(!r.ok) continue;
                    const t = await r.text();
                    t.split(/\r?\n/).slice(1).forEach(l => {
                        const c = l.split(';');
                        if(c[1]) db.push({ id: f+"_"+c[0], fr: c[1], nl: c[2].trim(), cat: f.replace('.csv','') });
                    });
                } catch(e) {}
            }
            updateUI();
            nextQuestion();
        }

        function switchView(v, btn) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.menu button').forEach(el => el.classList.remove('active'));
            document.getElementById(v + '-view').classList.add('active');
            btn.classList.add('active');
            if(v === 'duel') startDuel();
            if(v === 'review') renderReview();
        }

        function nextQuestion() {
            // Priorit√© aux mots "√Ä revoir"
            let pool = state.toReview.length > 0 && Math.random() > 0.4 
                       ? db.filter(i => state.toReview.includes(i.id))
                       : db.filter(i => !state.mastered.includes(i.id));
            
            if(pool.length === 0) pool = db;
            current = pool[Math.floor(Math.random()*pool.length)];
            
            document.getElementById('tag').innerText = current.cat;
            document.getElementById('q-text').innerText = current.fr;
            document.getElementById('ans-input').value = "";
            document.getElementById('feedback').innerText = "";
            document.getElementById('ans-input').focus();
        }

        function checkAnswer() {
            let input = document.getElementById('ans-input').value.toLowerCase().trim();
            let right = current.nl.toLowerCase().trim();
            
            if(input === right) {
                document.getElementById('feedback').innerText = "‚úÖ Excellent !";
                document.getElementById('feedback').style.color = "var(--duo-green)";
                if(!state.mastered.includes(current.id)) {
                    state.mastered.push(current.id);
                    state.xp += 10;
                }
                state.toReview = state.toReview.filter(id => id !== current.id);
                save();
                setTimeout(nextQuestion, 1000);
            } else {
                document.getElementById('feedback').innerText = "‚ùå " + current.nl;
                document.getElementById('feedback').style.color = "var(--duo-red)";
                if(!state.toReview.includes(current.id)) state.toReview.push(current.id);
                save();
            }
        }

        // Duel, Stats et Save
        function startDuel() {
            let item = db[Math.floor(Math.random()*db.length)];
            let choices = [item, ...db.filter(i=>i.id!==item.id).sort(()=>0.5-Math.random()).slice(0,3)].sort(()=>0.5-Math.random());
            [1,2].forEach(p => {
                document.getElementById('dq'+p).innerText = item.fr;
                const g = document.getElementById('do'+p); g.innerHTML = "";
                choices.forEach(c => {
                    let b = document.createElement('button'); b.className="duel-btn"; b.style.padding="10px"; b.innerText=c.nl;
                    b.onclick = () => { if(c.id===item.id) { alert("P"+p+" gagne!"); startDuel(); } else b.style.background="red"; };
                    g.appendChild(b);
                });
            });
        }

        function save() { localStorage.setItem('nl_master_global', JSON.stringify(state)); updateUI(); }
        
        function updateUI() {
            const m = state.mastered.length;
            document.getElementById('mastered-count').innerText = m;
            document.getElementById('xp').innerText = state.xp;
            document.getElementById('lvl').innerText = Math.floor(state.xp / 100) + 1;
            document.getElementById('p-bar').style.width = (state.xp % 100) + "%";
        }

        function renderReview() {
            const list = document.getElementById('review-list');
            list.innerHTML = state.toReview.length === 0 ? "<p>Rien √† revoir !</p>" : "";
            db.filter(i => state.toReview.includes(i.id)).forEach(i => {
                let d = document.createElement('div');
                d.style = "background:white; padding:10px; margin:5px; border-radius:10px; border-left:5px solid var(--duo-red)";
                d.innerHTML = `<b>${i.fr}</b> <br> <span style="color:var(--duo-green)">${i.nl}</span>`;
                list.appendChild(d);
            });
        }

        // Support touche Entr√©e
        document.getElementById('ans-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') checkAnswer(); });

        init();
    </script>
</body>
</html>
